<h2
  class="text-2xl text-center md:text-left md:text-3xl font-bold text-[var(--color-brand1)] border-b-4 border-[var(--color-brand2)] pb-2 mb-6 tracking-wide uppercase"
>
  Cart List
</h2>

@if (myCarts$ | async; as myCarts) {
  @if (myCarts.length !== 0) {
    <form [formGroup]="cartForm" class="space-y-6">
      <div
        formArrayName="libraries"
        class="relative max-h-[80vh] overflow-y-auto space-y-6"
      >
        @for (lib of myCarts; track lib.libraryId; let i = $index) {
          <div
            [formGroupName]="i"
            class="p-4 sm:p-6 rounded-lg shadow-md bg-brand4 border border-brand2"
          >
            <!-- ðŸ· Library Header -->
            <div class="flex items-center gap-3 mb-4">
              <input
                type="checkbox"
                formControlName="checked"
                (change)="toggleLibrary(i)"
                class="[accent-color:#b08968] w-5 h-5 text-brand2 bg-white border-brand2 rounded focus:ring-brand3 focus:ring-2 focus:outline-none"
              />
              <h2
                class="text-base sm:text-lg font-semibold text-brand1 truncate"
              >
                {{ lib.libraryName }}
              </h2>
            </div>

            <!-- ðŸ›’ Cart Items -->
            <ul formArrayName="carts" class="space-y-4">
              @for (cart of lib.carts; track cart.cartId; let j = $index) {
                <li
                  [formGroupName]="j"
                  class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-white border rounded-md"
                >
                  <!-- ðŸ“˜ Book Info -->
                  <div class="flex items-start gap-3 flex-1">
                    <input
                      type="checkbox"
                      formControlName="selected"
                      (change)="toggleItem(i)"
                      class="[accent-color:#b08968] w-5 h-5 text-brand2 bg-white border-brand2 rounded focus:ring-brand3 focus:ring-2 focus:outline-none mt-1"
                    />
                    <div class="flex min-w-0 justify-between space-x-4">
                      <p
                        class="text-brand2 font-medium text-sm sm:text-base truncate"
                        title="{{ cart.bookName }}"
                      >
                        {{ cart.bookName }}
                      </p>
                      <p class="text-sm text-brand5 mt-0.5">
                        â‚±{{ cart.price | number: '1.2-2' }}
                      </p>
                    </div>
                  </div>

                  <!-- ðŸ“¦ Quantity + Total + Remove -->
                  <div
                    class="flex flex-wrap sm:flex-nowrap items-center justify-between gap-3 sm:gap-4 w-full sm:w-auto"
                  >
                    <!-- Quantity Controls -->
                    <div
                      class="flex items-center justify-between gap-2 w-full sm:w-auto"
                    >
                      <button
                        type="button"
                        (click)="decreaseQuantity(i, j)"
                        class="w-8 h-8 bg-brand2 text-white rounded hover:bg-brand3 transition"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        formControlName="quantity"
                        class="w-16 text-center border border-brand2 rounded-md focus:outline-none focus:ring-1 focus:ring-brand3"
                        min="1"
                        [max]="cart.maxQuantity || 0"
                      />
                      <button
                        type="button"
                        (click)="increaseQuantity(i, j)"
                        class="w-8 h-8 bg-brand2 text-white rounded hover:bg-brand3 transition"
                      >
                        +
                      </button>
                    </div>

                    <!-- Price -->
                    <span
                      class="text-right text-brand1 font-semibold flex-1 sm:w-24"
                    >
                      â‚±{{ cart.price * getQuantity(i, j) }}
                    </span>

                    <!-- ðŸ—‘ Remove -->
                    <button
                      type="button"
                      (click)="removeCartItem(i, j, cart.cartId ?? 0)"
                      class="flex items-center justify-end text-red-600 hover:text-red-800 transition w-full sm:w-auto"
                    >
                      <lucide-icon
                        name="trash-2"
                        class="w-5 h-5"
                      ></lucide-icon>
                      <span class="ml-1 text-sm font-medium sm:hidden"
                        >Remove</span
                      >
                    </button>
                  </div>
                </li>
              }
            </ul>
          </div>
        }

        <!-- ðŸ§¾ Sticky Checkout Summary -->
        <div
          class="sticky bottom-0 bg-brand4 border-t border-brand2 p-4 z-10 flex flex-col sm:flex-row items-center justify-between gap-4"
        >
          <p
            class="text-lg font-bold text-brand1 text-center sm:text-left w-full sm:w-auto"
          >
            Total: â‚±{{ totalAmount }}
          </p>
          <button
            type="button"
            (click)="checkoutSelected()"
            class="px-6 py-3 bg-brand2 text-white font-semibold rounded-md hover:bg-brand3 transition w-full sm:w-auto"
          >
            Checkout
          </button>
        </div>
      </div>
    </form>
  } @else {
    <p class="text-center text-brand1 font-medium mt-10">
      Your cart is empty.
    </p>
  }
} @else {
  <div class="animate-pulse space-y-3">
    <div class="h-6 bg-gray-300 rounded w-1/4"></div>
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      @for (skeleton of [1, 2, 3]; track $index) {
        <div class="bg-gray-200 h-32 rounded-2xl"></div>
      }
    </div>
    <p class="text-gray-500 italic">Loading cart...</p>
  </div>
}
